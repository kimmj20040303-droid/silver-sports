<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Silver Sports</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Base Styles */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; transition: background-color 0.3s, color 0.3s; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        ::-webkit-scrollbar { width: 6px; background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 10px; }
        
        /* Animations */
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(0.95); } 100% { transform: scale(1); } }

        /* Accessibility Modes */
        body.mode-large-text { font-size: 120%; }
        body.mode-large-text button { font-size: 110%; }
        
        body.mode-high-contrast { background-color: #000000; color: #ffffff; }
        body.mode-high-contrast .bg-white { background-color: #1a1a1a; border-color: #333; color: #fff; }
        body.mode-high-contrast .bg-slate-50 { background-color: #000; }
        body.mode-high-contrast .text-slate-900 { color: #fff; }
        body.mode-high-contrast .text-slate-500 { color: #aaa; }
        body.mode-high-contrast .border-slate-200 { border-color: #444; }
        body.mode-high-contrast .shadow-sm { box-shadow: none; border: 2px solid #333; }
        
        /* High Contrast Button Overrides */
        body.mode-high-contrast .bg-blue-50 { background-color: #000; border: 2px solid #3b82f6; color: #60a5fa; }
        body.mode-high-contrast .bg-indigo-50 { background-color: #000; border: 2px solid #6366f1; color: #818cf8; }
        body.mode-high-contrast .bg-green-50 { background-color: #000; border: 2px solid #22c55e; color: #4ade80; }
        
        /* Toast Notification */
        .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; width: 90%; max-width: 400px; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    // --- 1. ICONS SYSTEM (Lucide React Clones) ---
    const Icon = ({ path, size = 24, className = "", fill = "none" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
    );

    const Icons = {
        Mic: (p) => <Icon {...p} path={<><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>} />,
        Home: (p) => <Icon {...p} path={<><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>} />,
        Ticket: (p) => <Icon {...p} path={<><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2z"/></>} />,
        User: (p) => <Icon {...p} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
        Volume2: (p) => <Icon {...p} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></>} />,
        VolumeX: (p) => <Icon {...p} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></>} />,
        ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />,
        MessageCircle: (p) => <Icon {...p} path={<><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></>} />,
        CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
        XCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>} />,
        Users: (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
        CreditCard: (p) => <Icon {...p} path={<><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></>} />,
        MapPin: (p) => <Icon {...p} path={<><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>} />,
        Sparkles: (p) => <Icon {...p} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5h4"/><path d="M19 17v4"/><path d="M15 19h4"/></>} />,
        Award: (p) => <Icon {...p} path={<><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>} />,
        Send: (p) => <Icon {...p} path={<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />,
        PlusCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></>} />,
        LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>} />,
        Settings: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>} />,
        Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
        Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
        Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />,
        Filter: (p) => <Icon {...p} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />
    };

    // --- 2. DATA & CONFIG ---
    
    // Initial Data to populate if LocalStorage is empty
    const INITIAL_DATA = {
        userProfile: { name: 'Kim', points: 1200 },
        myTickets: [],
        isLinked: false,
        conversationId: 'new',
        chatHistory: [],
        settings: {
            largeText: false,
            highContrast: false,
            voiceEnabled: true
        },
        groups: [
            { id: 1, name: 'Westside Walkers', members: 12, nextOuting: 'Baseball Game', nextOutingDate: new Date(Date.now() + 86400000).toISOString(), joined: false, createdByUser: false },
            { id: 2, name: 'Golden Years Club', members: 24, nextOuting: 'Soccer Match', nextOutingDate: new Date(Date.now() + 172800000).toISOString(), joined: true, createdByUser: false },
        ]
    };

    const EVENTS_DATA = [
        { id: 1, type: 'sport', sport: 'Baseball', team: 'City Tigers vs Bears', date: 'Tomorrow, 2:00 PM', price: 25, location: 'Central Stadium' },
        { id: 2, type: 'sport', sport: 'Soccer', team: 'United FC vs City', date: 'Sunday, 4:00 PM', price: 30, location: 'North Field' },
        { id: 3, type: 'art', sport: 'Musical', team: 'The Lion King', date: 'Nov 12, 7:00 PM', price: 50, location: 'Grand Theater' },
        { id: 4, type: 'art', sport: 'Orchestra', team: 'Symphony Night', date: 'Dec 5, 6:00 PM', price: 40, location: 'City Hall' },
    ];

    // --- 3. CUSTOM HOOKS ---

    // Persist State Hook: Automatically saves state to LocalStorage
    const usePersistentState = (key, defaultValue) => {
        const [state, setState] = React.useState(() => {
            const storedValue = localStorage.getItem(key);
            return storedValue ? JSON.parse(storedValue) : defaultValue;
        });

        React.useEffect(() => {
            localStorage.setItem(key, JSON.stringify(state));
        }, [key, state]);

        return [state, setState];
    };

    // --- 4. UTILITY COMPONENTS ---

    const NotificationToast = ({ message, type = 'success', onClose }) => {
        React.useEffect(() => {
            const timer = setTimeout(onClose, 3000);
            return () => clearTimeout(timer);
        }, [onClose]);

        const bg = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';

        return (
            <div className="toast-container animate-slide-up">
                <div className={`${bg} text-white px-6 py-4 rounded-2xl shadow-xl flex items-center justify-between`}>
                    <div className="flex items-center gap-3">
                        {type === 'success' ? <Icons.CheckCircle className="text-white" /> : <Icons.MessageCircle className="text-white" />}
                        <span className="font-bold text-lg">{message}</span>
                    </div>
                    <button onClick={onClose} className="text-white/80 hover:text-white"><Icons.XCircle size={20} /></button>
                </div>
            </div>
        );
    };

    const CountdownTimer = ({ targetDate }) => {
        const [timeLeft, setTimeLeft] = React.useState('');

        React.useEffect(() => {
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = new Date(targetDate).getTime() - now;
                if (distance < 0) {
                    setTimeLeft("Started");
                    clearInterval(interval);
                } else {
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    setTimeLeft(`${days}d ${hours}h ${minutes}m`);
                }
            }, 1000);
            return () => clearInterval(interval);
        }, [targetDate]);

        return <span className="font-mono text-blue-600 bg-blue-50 px-2 py-1 rounded font-bold">{timeLeft}</span>;
    };

    // --- 5. CORE SCREEN COMPONENTS ---

    const Header = ({ title, userProfile, goBack, showBack, settings, onToggleVoice, onSettings }) => (
        <div className="bg-white sticky top-0 z-20 p-4 shadow-sm flex items-center justify-between border-b border-slate-200">
            <div className="flex items-center gap-3">
                {showBack && <button onClick={goBack} className="bg-white p-3 rounded-xl border-2 border-slate-200 text-slate-700 active:bg-slate-100 hover:bg-slate-50 transition-colors"><Icons.ArrowLeft size={28} /></button>}
                <h1 className="text-2xl font-extrabold text-slate-800 tracking-tight">{title}</h1>
            </div>
            <div className="flex gap-2">
                <div className="hidden sm:flex items-center gap-1 bg-yellow-50 px-4 py-1 rounded-full border border-yellow-200">
                    <Icons.Award size={20} className="text-yellow-600" />
                    <span className="font-bold text-yellow-700">{userProfile.points}</span>
                </div>
                <button onClick={onSettings} className="p-3 rounded-full border-2 bg-slate-50 border-slate-200 text-slate-600 hover:bg-slate-100 active:scale-95 transition-transform"><Icons.Settings size={26} /></button>
                <button onClick={onToggleVoice} className={`p-3 rounded-full border-2 transition-colors ${settings.voiceEnabled ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-slate-50 border-slate-200 text-slate-400'}`}>
                    {settings.voiceEnabled ? <Icons.Volume2 size={26} /> : <Icons.VolumeX size={26} />}
                </button>
            </div>
        </div>
    );

    const SettingsScreen = ({ settings, userProfile, onUpdateSettings, onUpdateProfile, onClose }) => {
        const [editName, setEditName] = React.useState(userProfile.name);

        return (
            <div className="p-6 bg-slate-50 min-h-screen animate-fade-in pb-32">
                <h2 className="text-3xl font-bold text-slate-900 mb-6">Settings</h2>
                
                {/* Profile Section */}
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 mb-6">
                    <h3 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.User className="text-blue-600"/> My Profile</h3>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-bold text-slate-500 mb-1">Display Name</label>
                            <div className="flex gap-2">
                                <input type="text" value={editName} onChange={(e) => setEditName(e.target.value)} className="flex-1 p-3 border-2 border-slate-200 rounded-xl text-lg outline-none focus:border-blue-500" />
                                <button onClick={() => onUpdateProfile({ ...userProfile, name: editName })} className="bg-blue-600 text-white px-4 rounded-xl font-bold">Save</button>
                            </div>
                        </div>
                        <div className="p-4 bg-yellow-50 rounded-xl border border-yellow-100 flex justify-between items-center">
                            <span className="font-bold text-yellow-800">Reward Points</span>
                            <span className="text-2xl font-bold text-yellow-600">{userProfile.points}</span>
                        </div>
                    </div>
                </div>

                {/* Appearance Section */}
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 space-y-6">
                    <h3 className="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2"><Icons.Settings className="text-slate-600"/> Appearance</h3>
                    
                    <div className="flex justify-between items-center py-2 border-b border-slate-100">
                        <div>
                            <div className="text-xl font-bold text-slate-800">Large Text Mode</div>
                            <div className="text-slate-500 text-sm">Makes everything bigger</div>
                        </div>
                        <button onClick={() => onUpdateSettings('largeText', !settings.largeText)} className={`w-16 h-9 rounded-full relative transition-colors ${settings.largeText ? 'bg-green-500' : 'bg-slate-200'}`}>
                            <div className={`w-7 h-7 bg-white rounded-full absolute top-1 shadow-md transition-all ${settings.largeText ? 'right-1' : 'left-1'}`}></div>
                        </button>
                    </div>

                    <div className="flex justify-between items-center py-2">
                        <div>
                            <div className="text-xl font-bold text-slate-800">High Contrast</div>
                            <div className="text-slate-500 text-sm">Easier to read</div>
                        </div>
                        <button onClick={() => onUpdateSettings('highContrast', !settings.highContrast)} className={`w-16 h-9 rounded-full relative transition-colors ${settings.highContrast ? 'bg-green-500' : 'bg-slate-200'}`}>
                            <div className={`w-7 h-7 bg-white rounded-full absolute top-1 shadow-md transition-all ${settings.highContrast ? 'right-1' : 'left-1'}`}></div>
                        </button>
                    </div>
                </div>

                {/* Danger Zone */}
                <div className="mt-8 space-y-4">
                    <button onClick={() => { if(confirm('Clear chat history?')) onUpdateSettings('clearChat', true); }} className="w-full py-4 bg-white border-2 border-slate-200 text-slate-600 font-bold rounded-xl">Clear Chat History</button>
                    <button onClick={() => { if(confirm('Reset all app data?')) { localStorage.clear(); window.location.reload(); } }} className="w-full py-4 bg-red-50 text-red-600 border-2 border-red-100 font-bold rounded-xl">Reset App Data</button>
                </div>

                <button onClick={onClose} className="w-full bg-slate-800 text-white text-2xl font-bold py-5 rounded-2xl mt-8 shadow-lg">Close Settings</button>
            </div>
        );
    };

    const HomeScreen = ({ userProfile, navigate }) => {
        const BigButton = ({ onClick, icon: Icon, label, subLabel, isAi, colorClass }) => (
            <button onClick={onClick} className={`w-full text-slate-800 p-6 rounded-3xl shadow-sm border-2 transform transition active:scale-[0.98] flex items-center justify-between mb-4 group ${isAi ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-blue-400 hover:shadow-md'}`}>
                <div className="flex items-center gap-6">
                    <div className={`p-4 rounded-2xl transition-colors ${isAi ? 'bg-indigo-100 text-indigo-700' : 'bg-blue-50 text-blue-700 group-hover:bg-blue-600 group-hover:text-white'} ${colorClass || ''}`}>{Icon && <Icon size={40} />}</div>
                    <div className="text-left"><div className="text-2xl font-bold text-slate-900 flex items-center gap-2">{label} {isAi && <Icons.Sparkles size={24} className="text-indigo-500 fill-indigo-200" />}</div>{subLabel && <div className="text-lg text-slate-500 font-medium">{subLabel}</div>}</div>
                </div>
                <div className={`${isAi ? 'text-indigo-300' : 'text-slate-300 group-hover:text-blue-600'}`}><Icons.ArrowLeft size={28} className="rotate-180" /></div>
            </button>
        );

        return (
            <div className="p-6 flex flex-col h-full bg-slate-50 animate-fade-in">
                <div className="mb-8 p-6 bg-gradient-to-r from-blue-600 to-indigo-700 rounded-3xl shadow-lg text-white">
                    <h2 className="text-3xl font-bold mb-2">Hello, {userProfile.name}!</h2>
                    <p className="text-xl opacity-90 mb-4">Ready for an adventure?</p>
                    <div className="inline-flex items-center gap-2 bg-white/20 px-4 py-2 rounded-full backdrop-blur-sm">
                        <Icons.Award size={20} className="text-yellow-300" />
                        <span className="font-bold">{userProfile.points} Points Available</span>
                    </div>
                </div>
                <div className="space-y-2">
                    <BigButton onClick={() => navigate('events')} icon={Icons.Ticket} label="Manual Booking" subLabel="Browse games & events" />
                    <BigButton onClick={() => navigate('myTickets')} icon={Icons.User} label="My Tickets" subLabel="View purchased tickets" />
                    <BigButton onClick={() => navigate('aiHelp')} icon={Icons.MessageCircle} label="Ask Helper" subLabel="Chat assistance" isAi={true} />
                    <BigButton onClick={() => navigate('community')} icon={Icons.Users} label="Community Groups" subLabel="Join others" />
                    <BigButton onClick={() => navigate('guardian')} icon={Icons.Users} label="Family Link" subLabel="Connect to guardian" />
                </div>
            </div>
        );
    };

    const ManualBookingFlow = ({ screen, events, selectedEvent, ticketCount, paymentMethod, userProfile, onSelectEvent, onTicketChange, onPaymentMethod, onPurchase, navigate }) => {
        const [category, setCategory] = React.useState('all');
        const [usePoints, setUsePoints] = React.useState(false);

        // Filtering
        const filteredEvents = category === 'all' ? events : events.filter(e => e.type === category);

        // Checkout Logic
        const subtotal = selectedEvent ? selectedEvent.price * ticketCount : 0;
        const maxDiscount = Math.min(subtotal, Math.floor(userProfile.points / 100));
        const discount = usePoints ? maxDiscount : 0;
        const total = subtotal - discount;
        const pointsCost = discount * 100;

        if (screen === 'events') {
            return (
                <div className="p-4 bg-slate-50 min-h-screen pb-32 animate-fade-in">
                    {/* Filter Tabs */}
                    <div className="flex gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar">
                        {['all', 'sport', 'art'].map(cat => (
                            <button key={cat} onClick={() => setCategory(cat)} className={`px-6 py-3 rounded-full font-bold text-lg whitespace-nowrap transition-colors ${category === cat ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200'}`}>
                                {cat === 'all' ? 'All Events' : cat === 'sport' ? 'Sports' : 'Arts & Music'}
                            </button>
                        ))}
                    </div>
                    <div className="space-y-4">
                        {filteredEvents.map(event => (
                            <div key={event.id} onClick={() => onSelectEvent(event)} className="bg-white rounded-2xl p-6 shadow-sm border-2 border-transparent hover:border-blue-200 active:border-blue-600 cursor-pointer transition-all animate-slide-up">
                                <div className="flex justify-between items-start mb-4">
                                    <span className={`px-4 py-2 rounded-xl text-xl font-bold ${event.type === 'sport' ? 'bg-blue-50 text-blue-700' : 'bg-purple-50 text-purple-700'}`}>{event.sport}</span>
                                    <span className="text-3xl font-bold text-slate-900">${event.price}</span>
                                </div>
                                <h3 className="text-2xl font-bold text-slate-800 mb-2">{event.team}</h3>
                                <div className="flex items-center gap-2 text-xl text-slate-500 mb-2"><Icons.CreditCard size={24} /><span>{event.date}</span></div>
                                <div className="flex items-center gap-2 text-xl text-slate-500"><Icons.MapPin size={24} /><span>{event.location}</span></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        if (screen === 'eventDetails') {
            return (
                <div className="p-6 bg-slate-50 min-h-screen flex flex-col animate-fade-in">
                    <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 mb-6 text-center">
                        <h2 className="text-3xl font-bold text-slate-900 mb-4">{selectedEvent?.team}</h2>
                        <p className="text-2xl text-slate-600 mb-2">{selectedEvent?.date}</p>
                        <p className="text-2xl text-slate-600">{selectedEvent?.location}</p>
                    </div>
                    <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 mb-8">
                        <label className="text-2xl font-bold text-slate-800 mb-6 block text-center">How many tickets?</label>
                        <div className="flex items-center justify-between px-4">
                            <button onClick={() => onTicketChange(-1)} className="w-20 h-20 rounded-full bg-slate-100 text-slate-800 text-4xl font-bold hover:bg-slate-200">-</button>
                            <span className="text-6xl font-bold text-blue-800">{ticketCount}</span>
                            <button onClick={() => onTicketChange(1)} className="w-20 h-20 rounded-full bg-blue-50 text-blue-800 text-4xl font-bold hover:bg-blue-100">+</button>
                        </div>
                    </div>
                    <button onClick={() => navigate('checkout')} className="w-full bg-blue-700 text-white text-2xl font-bold py-6 rounded-2xl shadow-lg mt-auto hover:bg-blue-800 transition-colors">Next Step</button>
                </div>
            );
        }
        if (screen === 'checkout') {
            return (
                <div className="p-6 bg-slate-50 min-h-screen flex flex-col animate-fade-in">
                    <div className="mb-6 bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                        <div className="flex justify-between items-center mb-4">
                            <span className="text-xl text-slate-600">Subtotal</span>
                            <span className="text-2xl font-bold text-slate-900">${subtotal}</span>
                        </div>
                        
                        {/* Points Toggle */}
                        {userProfile.points >= 100 && (
                            <div className="flex justify-between items-center py-4 border-t border-slate-100">
                                <div>
                                    <div className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icons.Sparkles size={20} className="text-yellow-500"/> Use Points</div>
                                    <div className="text-slate-500">Available: {userProfile.points} (Save ${Math.floor(userProfile.points/100)})</div>
                                </div>
                                <button onClick={() => setUsePoints(!usePoints)} className={`w-16 h-9 rounded-full relative transition-colors ${usePoints ? 'bg-green-500' : 'bg-slate-300'}`}>
                                    <div className={`w-7 h-7 bg-white rounded-full absolute top-1 shadow-md transition-all ${usePoints ? 'right-1' : 'left-1'}`}></div>
                                </button>
                            </div>
                        )}

                        {usePoints && (
                            <div className="flex justify-between items-center text-green-600 font-bold mb-2 text-xl">
                                <span>Discount</span>
                                <span>-${discount}</span>
                            </div>
                        )}

                        <div className="flex justify-between items-center mt-4 pt-4 border-t-2 border-slate-100">
                            <span className="text-2xl font-bold text-slate-800">Total</span>
                            <span className="text-5xl font-extrabold text-blue-800">${total}</span>
                        </div>
                    </div>

                    <h3 className="text-xl font-bold text-slate-800 mb-4">Payment Method</h3>
                    <div className="space-y-4 mb-8">
                        {['offline', 'online', 'guardian_request'].map(method => (
                            <button key={method} onClick={() => onPaymentMethod(method)} className={`w-full p-5 rounded-2xl border-2 flex items-center gap-4 text-left transition-all ${paymentMethod === method ? (method === 'offline' ? 'border-green-600 bg-green-50' : method === 'online' ? 'border-blue-600 bg-blue-50' : 'border-pink-600 bg-pink-50') : 'border-slate-200 bg-white hover:border-slate-300'}`}>
                                <div className={`p-3 rounded-full ${method === 'offline' ? 'bg-green-100 text-green-700' : method === 'online' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'}`}>
                                    {method === 'offline' ? <Icons.Ticket size={32} /> : method === 'online' ? <Icons.CreditCard size={32} /> : <Icons.Users size={32} />}
                                </div>
                                <div>
                                    <div className="text-xl font-bold text-slate-900">{method === 'offline' ? 'Pay Offline' : method === 'online' ? 'Pay Card' : 'Ask Guardian'}</div>
                                    <div className="text-slate-500">{method === 'offline' ? 'Cash at stadium' : method === 'online' ? 'Secure payment' : 'Request payment'}</div>
                                </div>
                                {paymentMethod === method && <Icons.CheckCircle size={32} className={`${method === 'offline' ? 'text-green-600' : method === 'online' ? 'text-blue-600' : 'text-pink-600'} ml-auto`} />}
                            </button>
                        ))}
                    </div>
                    <button disabled={!paymentMethod} onClick={() => onPurchase(total, pointsCost)} className={`w-full text-white text-2xl font-bold py-6 rounded-2xl shadow-lg mt-auto transition-all ${!paymentMethod ? 'bg-slate-300 cursor-not-allowed' : 'bg-blue-700 hover:bg-blue-800 active:scale-[0.98]'}`}>
                        {total === 0 ? 'Get Ticket Free' : `Pay $${total}`}
                    </button>
                </div>
            );
        }
        return null;
    };

    const AiAssistantScreen = ({ chatMessages, chatInput, setChatInput, handleChatSubmit, handleChatOption, isAiLoading, chatStep }) => {
        const bottomRef = React.useRef(null);
        React.useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatMessages, isAiLoading]);

        const getOptions = () => {
            switch(chatStep) {
                case 'idle': return [{ label: "Book a Ticket", value: 'book', icon: Icons.Ticket }, { label: "My Tickets", value: 'mytickets', icon: Icons.User }];
                case 'picking_sport': return [{ label: "Baseball", value: 'Baseball' }, { label: "Soccer", value: 'Soccer' }, { label: "Musicals", value: 'Art' }, { label: "Cancel", value: 'cancel' }];
                case 'payment': return [{ label: "Pay Offline", value: 'offline' }, { label: "Pay Card", value: 'online' }];
                case 'success': return [{ label: "Go Home", value: 'home' }, { label: "See Tickets", value: 'mytickets' }];
                default: return [];
            }
        };
        const options = getOptions();

        return (
            <div className="flex flex-col h-[calc(100vh-80px)] bg-slate-50">
                <div className="flex-1 overflow-y-auto p-4 space-y-6">
                    {chatMessages.map((msg, idx) => (
                        <div key={idx} className={`flex flex-col ${msg.sender === 'user' ? 'items-end' : 'items-start'} animate-slide-up`}>
                            <div className={`max-w-[85%] p-5 rounded-2xl text-xl font-medium shadow-sm ${msg.sender === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-800 rounded-bl-none'}`}>{msg.text}</div>
                            {msg.uiType === 'event_cards' && (<div className="mt-4 space-y-3 w-full max-w-[90%]">{msg.data.map((event) => (<div key={event.id} className="bg-white border-2 border-indigo-100 p-4 rounded-xl shadow-sm animate-pop"><div className="font-bold text-lg text-slate-900">{event.team}</div><div className="text-slate-600">{event.date}</div><div className="flex justify-between items-center mt-2"><span className="font-bold text-indigo-700 text-xl">${event.price}</span><button onClick={() => handleChatOption({ label: `Select ${event.team}`, value: 'confirm_booking', data: event })} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow-md active:scale-95">Select</button></div></div>))}</div>)}
                        </div>
                    ))}
                    {isAiLoading && (<div className="flex justify-start animate-pulse"><div className="bg-white p-4 rounded-2xl rounded-bl-none border border-slate-200 flex items-center gap-2"><Icons.Sparkles size={20} className="text-indigo-500 animate-spin"/> <span className="text-slate-500 font-medium">Helper is thinking...</span></div></div>)}
                    <div ref={bottomRef} />
                </div>
                <div className="bg-white border-t border-slate-200 p-2 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                    {options.length > 0 && (<div className="mb-2 space-y-2 p-2 border-b border-slate-100 pb-4">{options.map((opt, idx) => (<button key={idx} onClick={() => opt.value === 'cancel' ? handleChatOption({ label: 'Cancel', value: 'cancel' }) : handleChatOption(opt)} className="w-full bg-white border-2 border-indigo-100 p-4 rounded-xl text-left flex items-center justify-between shadow-sm active:bg-indigo-50 transition-colors"><span className="text-lg font-bold text-slate-800">{opt.label}</span>{opt.icon && <opt.icon size={24} className="text-indigo-500" />}</button>))}</div>)}
                    <div className="flex gap-2 p-2"><input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleChatSubmit()} placeholder="Type a question..." className="flex-1 bg-slate-100 p-4 rounded-2xl text-xl border-2 border-slate-200 focus:border-blue-500 outline-none transition-all" /><button onClick={handleChatSubmit} className="bg-blue-600 text-white p-4 rounded-2xl shadow-md active:bg-blue-700 transition-colors"><Icons.Send size={28} /></button></div>
                </div>
            </div>
        );
    };

    const CommunityScreen = ({ groups, onJoin, onLeave, onDelete, onCreate }) => (
        <div className="p-4 bg-slate-50 min-h-screen animate-fade-in pb-20">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-slate-800">Community Groups</h2>
                <button onClick={onCreate} className="bg-blue-100 text-blue-700 px-5 py-2 rounded-xl font-bold flex items-center gap-2 active:bg-blue-200 hover:bg-blue-200 transition-colors"><Icons.PlusCircle size={22} /> Create</button>
            </div>
            <div className="space-y-4">
                {groups.map(group => (
                    <div key={group.id} className="bg-white rounded-3xl p-6 shadow-sm border border-slate-200 relative animate-slide-up">
                        {group.createdByUser && (
                            <button onClick={() => onDelete(group.id)} className="absolute top-4 right-4 text-slate-300 hover:text-red-500 p-2 transition-colors"><Icons.Trash2 size={22} /></button>
                        )}
                        <div className="flex justify-between items-start mb-2 pr-8">
                            <h3 className="text-2xl font-bold text-slate-900">{group.name}</h3>
                        </div>
                        <div className="text-slate-500 mb-4 flex items-center gap-2 font-medium"><Icons.Users size={18}/> {group.members} Members</div>
                        
                        <div className="bg-slate-50 p-4 rounded-2xl mb-6 border border-slate-100">
                            <div className="text-sm text-slate-500 mb-1">Next Outing</div>
                            <div className="flex items-center justify-between">
                                <span className="font-bold text-slate-800 text-lg">{group.nextOuting}</span>
                                <div className="flex items-center gap-2 text-sm"><Icons.Clock size={16} className="text-blue-500"/><CountdownTimer targetDate={group.nextOutingDate} /></div>
                            </div>
                        </div>

                        {group.joined ? (
                            <div className="flex gap-3 animate-pop">
                                <div className="flex-1 bg-green-100 text-green-800 font-bold py-3 rounded-xl flex items-center justify-center gap-2 text-lg"><Icons.CheckCircle size={22}/> Joined</div>
                                <button onClick={() => onLeave(group.id)} className="px-6 bg-white text-red-600 font-bold rounded-xl border-2 border-red-100 hover:bg-red-50">Leave</button>
                            </div>
                        ) : (
                            <button onClick={() => onJoin(group.id)} className="w-full py-4 bg-blue-600 text-white font-bold rounded-xl text-lg shadow-md active:scale-95 transition-transform hover:bg-blue-700">Join Group</button>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );

    const MyTicketsScreen = ({ tickets, isLinked, onSend, onCancelSend }) => (
        <div className="p-6 bg-slate-50 min-h-screen pb-20 animate-fade-in">
            {tickets.length === 0 ? (
                <div className="text-center mt-20 opacity-60">
                    <div className="bg-slate-200 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Ticket size={40} className="text-slate-400"/></div>
                    <p className="text-xl text-slate-500 font-medium">No tickets yet.</p>
                </div>
            ) : (
                tickets.map((ticket, idx) => (
                    <div key={idx} className="bg-white border border-slate-200 rounded-3xl p-6 mb-6 shadow-sm animate-slide-up relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-2 h-full bg-blue-500"></div>
                        <div className="flex justify-between items-start mb-4 pl-4">
                            <div><h3 className="text-2xl font-bold text-slate-900 leading-tight">{ticket.team}</h3><p className="text-xl text-slate-500 mt-1">{ticket.date}</p></div>
                            <span className="bg-slate-100 px-4 py-2 rounded-xl font-bold text-slate-700">x{ticket.count}</span>
                        </div>
                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 mb-4 ml-4">
                            <p className={`text-xl font-bold flex items-center gap-2 ${ticket.status.includes('Paid') ? 'text-green-600' : ticket.status.includes('Request') ? 'text-pink-600' : 'text-orange-600'}`}>
                                {ticket.status.includes('Paid') && <Icons.CheckCircle size={24}/>}
                                {ticket.isGift ? 'Sent to Guardian' : ticket.status}
                            </p>
                        </div>
                        {isLinked && (
                            <div className="ml-4">
                                {!ticket.isGift ? (
                                    <button onClick={() => onSend(ticket.purchaseId)} className="w-full py-4 bg-white border-2 border-slate-200 text-slate-700 font-bold rounded-xl flex items-center justify-center gap-2 text-xl hover:bg-slate-50 active:scale-[0.99] transition-transform"><Icons.Send size={24} /> Send to Family</button>
                                ) : (
                                    <button onClick={() => onCancelSend(ticket.purchaseId)} className="w-full py-4 bg-pink-50 border-2 border-pink-100 text-pink-700 font-bold rounded-xl flex items-center justify-center gap-2 text-xl hover:bg-pink-100 active:scale-[0.99]"><Icons.LogOut size={24} /> Cancel Sending</button>
                                )}
                            </div>
                        )}
                    </div>
                ))
            )}
        </div>
    );

    // --- 6. MAIN APP CONTAINER ---

    function App() {
        // Global State with Persistence
        const [userProfile, setUserProfile] = usePersistentState('userProfile', INITIAL_DATA.userProfile);
        const [myTickets, setMyTickets] = usePersistentState('myTickets', INITIAL_DATA.myTickets);
        const [groups, setGroups] = usePersistentState('groups', INITIAL_DATA.groups);
        const [isLinked, setIsLinked] = usePersistentState('isLinked', INITIAL_DATA.isLinked);
        const [settings, setSettings] = usePersistentState('settings', INITIAL_DATA.settings);
        const [chatHistory, setChatHistory] = usePersistentState('chatHistory', INITIAL_DATA.chatHistory);
        
        // Local State (Session only)
        const [currentScreen, setCurrentScreen] = React.useState('home');
        const [conversationId, setConversationId] = React.useState('new');
        const [notification, setNotification] = React.useState(null);
        const [showSettings, setShowSettings] = React.useState(false);
        
        // Booking State
        const [selectedEvent, setSelectedEvent] = React.useState(null);
        const [ticketCount, setTicketCount] = React.useState(1);
        const [paymentMethod, setPaymentMethod] = React.useState(null);
        const [showConfirmModal, setShowConfirmModal] = React.useState(false);
        const [purchaseDetails, setPurchaseDetails] = React.useState({ total: 0, pointsCost: 0 });

        // Chat State
        const [chatInput, setChatInput] = React.useState('');
        const [isAiLoading, setIsAiLoading] = React.useState(false);
        const [chatStep, setChatStep] = React.useState('idle');

        // --- Effects ---
        
        // Apply Accessibility Settings
        React.useEffect(() => {
            document.body.className = ''; // Reset
            if (settings.largeText) document.body.classList.add('mode-large-text');
            if (settings.highContrast) document.body.classList.add('mode-high-contrast');
        }, [settings]);

        // --- Helper Functions ---

        const notify = (msg, type = 'success') => setNotification({ msg, type });
        
        const speak = (text) => {
            if (!settings.voiceEnabled) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        };

        // --- Action Handlers ---

        // Booking
        const onSelectEvent = (e) => { setSelectedEvent(e); setCurrentScreen('eventDetails'); speak(e.team); };
        const handlePreparePurchase = (total, pointsCost) => { setPurchaseDetails({ total, pointsCost }); setShowConfirmModal(true); speak("Please confirm."); };
        
        const confirmManualPurchase = () => {
            const { total, pointsCost } = purchaseDetails;
            const newPoints = userProfile.points - pointsCost + Math.floor(total * 10);
            
            setUserProfile(prev => ({ ...prev, points: newPoints }));
            
            const status = paymentMethod === 'offline' ? 'Reserved (Pay at Counter)' : paymentMethod === 'guardian_request' ? 'Request Sent to Guardian' : 'Paid';
            const newTicket = { ...selectedEvent, count: ticketCount, purchaseId: Math.floor(Math.random() * 10000), status: status, isGift: false };
            
            setMyTickets(prev => [...prev, newTicket]);
            setShowConfirmModal(false);
            setCurrentScreen('success');
            notify("Ticket Purchased!");
            speak("Success! Ticket added.");
        };

        // Groups
        const handleJoinGroup = (id) => { setGroups(prev => prev.map(g => g.id === id ? { ...g, joined: true, members: g.members + 1 } : g)); notify("Joined Group"); speak("Group joined."); };
        const handleLeaveGroup = (id) => { setGroups(prev => prev.map(g => g.id === id ? { ...g, joined: false, members: g.members - 1 } : g)); notify("Left Group", 'info'); speak("Left group."); };
        const handleDeleteGroup = (id) => { if(confirm("Delete this group?")) { setGroups(prev => prev.filter(g => g.id !== id)); notify("Group Deleted", 'error'); } };
        const handleCreateGroup = () => { 
            const newGroup = { id: Date.now(), name: 'New Bowling Team', members: 1, nextOuting: 'Bowling Night', nextOutingDate: new Date(Date.now() + 604800000).toISOString(), joined: true, createdByUser: true };
            setGroups(prev => [...prev, newGroup]); notify("Group Created!"); speak("New group created."); 
        };

        // Guardian & Tickets
        const handleGuardianLink = () => { setIsLinked(true); notify("Account Linked!"); speak("Connected."); };
        const handleSendTicket = (id) => { setMyTickets(prev => prev.map(t => t.purchaseId === id ? { ...t, isGift: true } : t)); notify("Ticket Sent!"); speak("Ticket sent."); };
        const handleCancelSend = (id) => { setMyTickets(prev => prev.map(t => t.purchaseId === id ? { ...t, isGift: false } : t)); notify("Sending Cancelled"); speak("Cancelled."); };

        // Chat
        const addChatMessage = (sender, text, uiType = 'text', data = null) => {
            setChatHistory(prev => [...prev, { sender, text, uiType, data }]);
            if (sender === 'ai') speak(text);
        };

        const handleChatSubmit = async () => {
            if (!chatInput.trim()) return;
            const text = chatInput; setChatInput(''); 
            addChatMessage('user', text); 
            setIsAiLoading(true);
            
            try {
                const response = await fetch(`/message/${conversationId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text }) });
                if (!response.ok) throw new Error('Err');
                const data = await response.json();
                if (data.conversationId) setConversationId(data.conversationId);
                addChatMessage('ai', data.response);
            } catch (e) { addChatMessage('ai', "Connection error."); } 
            finally { setIsAiLoading(false); }
        };

        const handleChatOption = (option) => {
            if (option.value === 'cancel') { setChatStep('idle'); addChatMessage('ai', "Okay, how else can I help?"); return; }
            if (option.value === 'confirm_booking') { 
                addChatMessage('ai', `Selected ${option.data.team}. How to pay?`); 
                setSelectedEvent(option.data); 
                setChatStep('payment'); 
                return; 
            }

            addChatMessage('user', option.label);
            setTimeout(() => {
                if (chatStep === 'idle' && option.value === 'book') { addChatMessage('ai', "What kind of event?"); setChatStep('picking_sport'); }
                else if (chatStep === 'idle' && option.value === 'mytickets') { addChatMessage('ai', "Opening tickets..."); setCurrentScreen('myTickets'); }
                else if (chatStep === 'picking_sport') {
                    const matches = EVENTS_DATA.filter(e => e.sport === option.value || e.type === option.value.toLowerCase());
                    addChatMessage('ai', `I found these ${option.label} events:`, 'text');
                    setChatHistory(prev => [...prev, { sender: 'ai', uiType: 'event_cards', data: matches }]);
                }
                else if (chatStep === 'payment') {
                    const isOffline = option.value === 'offline';
                    const newTicket = { ...selectedEvent, count: 1, purchaseId: Math.floor(Math.random()*10000), status: isOffline ? 'Reserved' : 'Paid', isGift: false };
                    setMyTickets(prev => [...prev, newTicket]);
                    addChatMessage('ai', "Ticket booked!");
                    setChatStep('success');
                }
                else if (chatStep === 'success') {
                    if (option.value === 'home') setCurrentScreen('home');
                    if (option.value === 'mytickets') setCurrentScreen('myTickets');
                }
            }, 500);
        };

        // Initialization
        React.useEffect(() => {
            if (currentScreen === 'aiHelp' && chatHistory.length === 0) {
                addChatMessage('ai', "Hello! I am your Silver Sports Assistant. How can I help you today?");
            }
        }, [currentScreen]);

        const navigate = (screen) => { setCurrentScreen(screen); speak(screen === 'home' ? "Home" : screen); };

        // Settings Update
        const updateSettings = (key, val) => {
            if (key === 'clearChat') { setChatHistory([]); notify("Chat Cleared"); return; }
            setSettings(prev => ({ ...prev, [key]: val }));
        };

        // --- Render ---
        if (showSettings) return (
            <SettingsScreen 
                settings={settings} 
                userProfile={userProfile} 
                onUpdateSettings={updateSettings} 
                onUpdateProfile={setUserProfile}
                onClose={() => setShowSettings(false)} 
            />
        );

        return (
            <div className="font-sans max-w-lg mx-auto bg-slate-50 min-h-screen shadow-2xl overflow-hidden relative selection:bg-blue-100">
                <Header 
                    title={currentScreen === 'home' ? 'Silver Sports' : currentScreen === 'aiHelp' ? 'Assistant' : 'Back'} 
                    userProfile={userProfile} 
                    goBack={() => setCurrentScreen(currentScreen === 'checkout' ? 'eventDetails' : currentScreen === 'eventDetails' ? 'events' : 'home')} 
                    showBack={currentScreen !== 'home'} 
                    settings={settings}
                    onToggleVoice={() => updateSettings('voiceEnabled', !settings.voiceEnabled)}
                    onSettings={() => setShowSettings(true)} 
                />
                
                <main className="pb-safe">
                    {currentScreen === 'home' && <HomeScreen userProfile={userProfile} navigate={navigate} />}
                    
                    {(currentScreen === 'events' || currentScreen === 'eventDetails' || currentScreen === 'checkout') && 
                        <ManualBookingFlow 
                            screen={currentScreen} 
                            events={EVENTS_DATA} 
                            selectedEvent={selectedEvent} 
                            ticketCount={ticketCount} 
                            paymentMethod={paymentMethod} 
                            userProfile={userProfile}
                            onSelectEvent={onSelectEvent} 
                            onTicketChange={(d) => setTicketCount(Math.max(1, ticketCount + d))} 
                            onPaymentMethod={setPaymentMethod} 
                            onPurchase={handlePreparePurchase} 
                            navigate={navigate} 
                        />
                    }
                    
                    {currentScreen === 'aiHelp' && 
                        <AiAssistantScreen 
                            chatMessages={chatHistory} 
                            chatInput={chatInput} 
                            setChatInput={setChatInput} 
                            handleChatSubmit={handleChatSubmit} 
                            handleChatOption={handleChatOption} 
                            isAiLoading={isAiLoading} 
                            chatStep={chatStep} 
                        />
                    }
                    
                    {currentScreen === 'community' && 
                        <CommunityScreen 
                            groups={groups} 
                            onJoin={handleJoinGroup} 
                            onLeave={handleLeaveGroup} 
                            onDelete={handleDeleteGroup} 
                            onCreate={handleCreateGroup} 
                        />
                    }
                    
                    {currentScreen === 'guardian' && (
                        <div className="p-6 text-center animate-fade-in">
                            <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 mb-8">
                                <div className="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Users size={40} className="text-slate-500" /></div>
                                <h2 className="text-3xl font-bold text-slate-900 mb-2">{isLinked ? "Sarah (Daughter)" : "Connect Family"}</h2>
                                <p className="text-xl text-slate-500">{isLinked ? "Account is linked. You can share tickets instantly." : "Link accounts to send tickets easily."}</p>
                            </div>
                            {!isLinked ? 
                                <button onClick={handleGuardianLink} className="w-full bg-blue-700 text-white py-5 rounded-2xl text-2xl font-bold shadow-lg hover:bg-blue-800 transition-colors">Link Account</button> 
                                : <div className="bg-green-100 p-6 rounded-2xl text-green-800 font-bold text-2xl flex items-center justify-center gap-2"><Icons.CheckCircle size={28}/> Active Connection</div>
                            }
                        </div>
                    )}
                    
                    {currentScreen === 'myTickets' && <MyTicketsScreen tickets={myTickets} isLinked={isLinked} onSend={handleSendTicket} onCancelSend={handleCancelSend} />}
                    
                    {currentScreen === 'success' && (
                        <div className="p-6 text-center pt-32 animate-fade-in">
                            <div className="inline-block p-6 bg-green-100 rounded-full mb-6"><Icons.CheckCircle size={60} className="text-green-600"/></div>
                            <h2 className="text-4xl font-extrabold text-slate-900 mb-8">Success!</h2>
                            <button onClick={() => setCurrentScreen('home')} className="w-full bg-slate-800 text-white py-5 rounded-2xl text-2xl font-bold shadow-lg">Go Home</button>
                        </div>
                    )}
                </main>

                {/* Modals & Toasts */}
                {showConfirmModal && (
                    <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
                        <div className="bg-white w-full rounded-3xl p-8 text-center shadow-2xl animate-pop">
                            <h2 className="text-3xl font-bold mb-4 text-slate-900">Confirm?</h2>
                            <p className="text-xl text-slate-600 mb-8">
                                Total: <span className="font-bold text-slate-900">${purchaseDetails.total}</span> <br/> 
                                {purchaseDetails.pointsCost > 0 && <span className="text-green-600 text-lg">Using {purchaseDetails.pointsCost} Points</span>}
                            </p>
                            <div className="space-y-4">
                                <button onClick={confirmManualPurchase} className="w-full bg-blue-700 text-white py-5 rounded-2xl text-2xl font-bold shadow-lg hover:bg-blue-800">Buy Now</button>
                                <button onClick={() => setShowConfirmModal(false)} className="w-full bg-white text-slate-700 border-2 border-slate-300 py-5 rounded-2xl text-2xl font-bold hover:bg-slate-50">Cancel</button>
                            </div>
                        </div>
                    </div>
                )}
                
                {notification && <NotificationToast message={notification.msg} type={notification.type} onClose={() => setNotification(null)} />}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>

</body>
</html>