<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Silver Sports</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    // --- ICONS (Lucide-React Clones) ---
    const Icon = ({ path, size = 24, className = "", fill = "none" }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
    );

    const Mic = (p) => <Icon {...p} path={<><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>} />;
    const Home = (p) => <Icon {...p} path={<><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>} />;
    const Ticket = (p) => <Icon {...p} path={<><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2z"/></>} />;
    const User = (p) => <Icon {...p} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
    const Volume2 = (p) => <Icon {...p} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></>} />;
    const ArrowLeft = (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />;
    const MessageCircle = (p) => <Icon {...p} path={<><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></>} />;
    const CheckCircle = (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
    const XCircle = (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></>} />;
    const Users = (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
    const CreditCard = (p) => <Icon {...p} path={<><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></>} />;
    const MapPin = (p) => <Icon {...p} path={<><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>} />;
    const Sparkles = (p) => <Icon {...p} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5h4"/><path d="M19 17v4"/><path d="M15 19h4"/></>} />;
    const Award = (p) => <Icon {...p} path={<><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>} />;
    const Send = (p) => <Icon {...p} path={<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />;
    const PlusCircle = (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></>} />;
    const LogOut = (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>} />;

    // --- Data Constants ---
    const EVENTS_DATA = [
        { id: 1, sport: 'Baseball', team: 'City Tigers vs Bears', date: 'Tomorrow, 2:00 PM', price: 25, location: 'Central Stadium', type: 'Sport' },
        { id: 2, sport: 'Soccer', team: 'United FC vs City', date: 'Sunday, 4:00 PM', price: 30, location: 'North Field', type: 'Sport' },
        { id: 3, sport: 'Musical', team: 'The Lion King', date: 'Nov 12, 7:00 PM', price: 50, location: 'Grand Theater', type: 'Art' },
    ];

    const INITIAL_GROUPS = [
        { id: 1, name: 'Westside Walkers', eventId: 1, members: 12, nextOuting: 'Baseball Game' },
        { id: 2, name: 'Golden Years Club', eventId: 2, members: 24, nextOuting: 'Soccer Match' },
    ];

    // --- Shared Components ---
    
    const BigButton = ({ onClick, icon: Icon, label, subLabel, isAi, colorClass }) => (
        <button onClick={onClick} className={`w-full text-slate-800 p-6 rounded-2xl shadow-sm border-2 transform transition active:scale-95 flex items-center justify-between mb-4 group ${isAi ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-blue-600'}`}>
            <div className="flex items-center gap-6">
                <div className={`p-4 rounded-full transition-colors ${isAi ? 'bg-indigo-100 text-indigo-700' : 'bg-blue-50 text-blue-700 group-hover:bg-blue-100'} ${colorClass || ''}`}>
                    {Icon && <Icon size={40} />}
                </div>
                <div className="text-left">
                    <div className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                        {label} {isAi && <Sparkles size={24} className="text-indigo-500 fill-indigo-200" />}
                    </div>
                    {subLabel && <div className="text-lg text-slate-500 font-medium">{subLabel}</div>}
                </div>
            </div>
            <div className={`${isAi ? 'text-indigo-300' : 'text-slate-300 group-hover:text-blue-600'}`}><ArrowLeft size={28} className="rotate-180" /></div>
        </button>
    );

    const Header = ({ title, userProfile, goBack, showBack, voiceActive, toggleVoice }) => (
        <div className="bg-white sticky top-0 z-10 p-4 shadow-sm flex items-center justify-between border-b border-slate-200">
            <div className="flex items-center gap-3">
                {showBack && <button onClick={goBack} className="bg-white p-3 rounded-xl border-2 border-slate-200 text-slate-700 active:bg-slate-100"><ArrowLeft size={28} /></button>}
                <h1 className="text-2xl font-bold text-slate-800 tracking-tight">{title}</h1>
            </div>
            <div className="flex gap-2">
                {userProfile && (
                    <div className="hidden sm:flex items-center gap-1 bg-yellow-50 px-3 rounded-full border border-yellow-200">
                        <Award size={20} className="text-yellow-600" />
                        <span className="font-bold text-yellow-700">{userProfile.points}</span>
                    </div>
                )}
                <button onClick={toggleVoice} className={`p-3 rounded-full border-2 ${voiceActive ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-slate-50 border-slate-200 text-slate-400'}`}><Volume2 size={28} /></button>
            </div>
        </div>
    );

    // --- Screens ---

    const HomeScreen = ({ userProfile, navigate }) => (
        <div className="p-6 flex flex-col h-full bg-slate-50">
            <div className="mb-6 p-4 bg-white rounded-2xl border border-slate-200 shadow-sm">
                <h2 className="text-3xl font-bold text-slate-900 mb-1">Hello, {userProfile.name}!</h2>
                <p className="text-xl text-slate-500">What would you like to do?</p>
            </div>
            <BigButton onClick={() => navigate('events')} icon={Ticket} label="Manual Booking" subLabel="Browse games list" />
            <BigButton onClick={() => navigate('myTickets')} icon={User} label="My Tickets" subLabel="View your tickets" />
            <BigButton onClick={() => navigate('aiHelp')} icon={MessageCircle} label="Ask Helper" subLabel="Chat assistance" isAi={true} />
            <BigButton onClick={() => navigate('community')} icon={Users} label="Community Groups" subLabel="Join others" />
            <BigButton onClick={() => navigate('guardian')} icon={Users} label="Family Link" subLabel="Connect to guardian" />
        </div>
    );

    const ManualBookingFlow = ({ screen, events, selectedEvent, ticketCount, paymentMethod, onSelectEvent, onTicketChange, onPaymentMethod, onPurchase, navigate }) => {
        if (screen === 'events') {
            return (
                <div className="p-4 bg-slate-50 min-h-screen pb-32"><div className="space-y-4">{events.map(event => (<div key={event.id} onClick={() => onSelectEvent(event)} className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 active:border-blue-600 cursor-pointer"><div className="flex justify-between items-start mb-4"><span className="bg-slate-100 text-slate-800 px-4 py-2 rounded-xl text-xl font-bold">{event.sport}</span><span className="text-3xl font-bold text-blue-700">${event.price}</span></div><h3 className="text-2xl font-bold text-slate-800 mb-2">{event.team}</h3><div className="flex items-center gap-2 text-xl text-slate-500 mb-2"><CreditCard size={24} /><span>{event.date}</span></div></div>))}</div></div>
            );
        }
        if (screen === 'eventDetails') {
            return (
                <div className="p-6 bg-slate-50 min-h-screen flex flex-col"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6 text-center"><h2 className="text-3xl font-bold text-slate-900 mb-4">{selectedEvent?.team}</h2><p className="text-2xl text-slate-600 mb-2">{selectedEvent?.date}</p><p className="text-2xl text-slate-600">{selectedEvent?.location}</p></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8"><label className="text-2xl font-bold text-slate-800 mb-6 block text-center">How many tickets?</label><div className="flex items-center justify-between px-4"><button onClick={() => onTicketChange(-1)} className="w-16 h-16 rounded-full bg-slate-100 text-slate-800 text-3xl font-bold">-</button><span className="text-5xl font-bold text-blue-800">{ticketCount}</span><button onClick={() => onTicketChange(1)} className="w-16 h-16 rounded-full bg-blue-50 text-blue-800 text-3xl font-bold">+</button></div></div><button onClick={() => navigate('checkout')} className="w-full bg-blue-700 text-white text-2xl font-bold py-5 rounded-2xl shadow-lg mt-auto">Next Step</button></div>
            );
        }
        if (screen === 'checkout') {
            return (
                <div className="p-6 bg-slate-50 min-h-screen flex flex-col"><div className="mb-8"><h3 className="text-2xl font-bold text-slate-800 mb-4">Total:</h3><div className="text-5xl font-extrabold text-blue-800">${selectedEvent?.price * ticketCount}</div></div><div className="space-y-4 mb-8"><button onClick={() => onPaymentMethod('offline')} className={`w-full p-6 rounded-2xl border-2 flex items-center gap-4 text-left ${paymentMethod === 'offline' ? 'border-green-600 bg-green-50' : 'border-slate-200 bg-white'}`}><div className="bg-green-100 p-3 rounded-full"><Ticket size={32} className="text-green-700" /></div><div><div className="text-2xl font-bold text-slate-900">Pay Offline</div><div className="text-slate-500">Cash at stadium</div></div>{paymentMethod === 'offline' && <CheckCircle size={32} className="text-green-600 ml-auto" />}</button><button onClick={() => onPaymentMethod('online')} className={`w-full p-6 rounded-2xl border-2 flex items-center gap-4 text-left ${paymentMethod === 'online' ? 'border-blue-600 bg-blue-50' : 'border-slate-200 bg-white'}`}><div className="bg-blue-100 p-3 rounded-full"><CreditCard size={32} className="text-blue-700" /></div><div><div className="text-2xl font-bold text-slate-900">Pay Card</div><div className="text-slate-500">Secure payment</div></div>{paymentMethod === 'online' && <CheckCircle size={32} className="text-blue-600 ml-auto" />}</button><button onClick={() => onPaymentMethod('guardian_request')} className={`w-full p-6 rounded-2xl border-2 flex items-center gap-4 text-left ${paymentMethod === 'guardian_request' ? 'border-pink-600 bg-pink-50' : 'border-slate-200 bg-white'}`}><div className="bg-pink-100 p-3 rounded-full"><Users size={32} className="text-pink-700" /></div><div><div className="text-2xl font-bold text-slate-900">Ask Guardian</div><div className="text-slate-500">Request payment</div></div>{paymentMethod === 'guardian_request' && <CheckCircle size={32} className="text-pink-600 ml-auto" />}</button></div><button disabled={!paymentMethod} onClick={onPurchase} className={`w-full text-white text-2xl font-bold py-5 rounded-2xl shadow-lg mt-auto ${!paymentMethod ? 'bg-slate-300' : 'bg-blue-700'}`}>Buy Tickets</button></div>
            );
        }
        return null;
    };

    // Chat Screen Component
    const { useState, useEffect, useRef } = React;
    const AiAssistantScreen = ({ chatMessages, chatInput, setChatInput, handleChatSubmit, handleChatOption, isAiLoading, chatStep }) => {
        const bottomRef = useRef(null);
        useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatMessages]);

        const getOptions = () => {
            switch(chatStep) {
                case 'idle': return [{ label: "Book a Ticket", value: 'book', icon: Ticket }, { label: "My Tickets", value: 'mytickets', icon: User }];
                case 'picking_sport': return [{ label: "Baseball", value: 'Baseball' }, { label: "Soccer", value: 'Soccer' }, { label: "Musicals", value: 'Art' }, { label: "Cancel", value: 'cancel' }];
                case 'payment': return [{ label: "Pay Offline", value: 'offline' }, { label: "Pay Card", value: 'online' }];
                case 'success': return [{ label: "Go Home", value: 'home' }, { label: "See Tickets", value: 'mytickets' }];
                default: return [];
            }
        };
        const options = getOptions();

        return (
            <div className="flex flex-col h-[calc(100vh-80px)] bg-slate-50">
                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                    {chatMessages.map((msg, idx) => (
                        <div key={idx} className={`flex flex-col ${msg.sender === 'user' ? 'items-end' : 'items-start'}`}>
                            <div className={`max-w-[85%] p-5 rounded-2xl text-xl font-medium shadow-sm ${msg.sender === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-800 rounded-bl-none'}`}>{msg.text}</div>
                            {msg.uiType === 'event_cards' && (<div className="mt-4 space-y-3 w-full max-w-[90%]">{msg.data.map((event) => (<div key={event.id} className="bg-white border-2 border-indigo-100 p-4 rounded-xl shadow-sm"><div className="font-bold text-lg text-slate-900">{event.team}</div><div className="text-slate-600">{event.date}</div><div className="flex justify-between items-center mt-2"><span className="font-bold text-indigo-700 text-xl">${event.price}</span><button onClick={() => handleChatOption({ label: `Select ${event.team}`, value: 'confirm_booking', data: event })} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold">Select</button></div></div>))}</div>)}
                        </div>
                    ))}
                    {isAiLoading && (<div className="flex justify-start"><div className="bg-white p-4 rounded-2xl rounded-bl-none border border-slate-200 flex items-center gap-2"><div className="text-indigo-500">...</div><span className="text-slate-400">Helper is thinking...</span></div></div>)}
                    <div ref={bottomRef} />
                </div>
                <div className="bg-white border-t border-slate-200 p-2 pb-safe">
                    {options.length > 0 && (<div className="mb-2 space-y-2 p-2">{options.map((opt, idx) => (<button key={idx} onClick={() => opt.value === 'cancel' ? handleChatOption({ label: 'Cancel', value: 'cancel' }) : handleChatOption(opt)} className="w-full bg-white border-2 border-indigo-100 p-3 rounded-xl text-left flex items-center justify-between shadow-sm active:bg-indigo-50"><span className="text-lg font-bold text-slate-800">{opt.label}</span>{opt.icon && <opt.icon size={20} className="text-indigo-500" />}</button>))}</div>)}
                    <div className="flex gap-2 p-2"><input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleChatSubmit()} placeholder="Type a question..." className="flex-1 bg-slate-100 p-4 rounded-xl text-xl border-2 border-slate-200 focus:border-indigo-500 outline-none" /><button onClick={handleChatSubmit} className="bg-indigo-600 text-white p-4 rounded-xl shadow-md active:bg-indigo-700"><Send size={28} /></button></div>
                </div>
            </div>
        );
    };

    const CommunityScreen = ({ groups, onCreateGroup }) => (
        <div className="p-4 bg-slate-50 min-h-screen"><div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-slate-800">Community Groups</h2><button onClick={onCreateGroup} className="bg-blue-100 text-blue-700 px-4 py-2 rounded-xl font-bold flex items-center gap-2 active:bg-blue-200"><PlusCircle size={20} /> Create</button></div><div className="space-y-4">{groups.map(group => (<div key={group.id} className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200"><div className="flex justify-between items-start mb-2"><h3 className="text-2xl font-bold text-slate-900">{group.name}</h3><span className="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-lg font-bold">{group.members} Members</span></div><div className="text-xl text-slate-600 mb-4">Going to: <span className="font-semibold text-blue-700">{group.nextOuting}</span></div><button className="w-full py-3 bg-slate-100 text-slate-700 font-bold rounded-xl text-lg hover:bg-blue-600 hover:text-white transition-colors">Join Group</button></div>))}</div></div>
    );

    const FamilyLinkScreen = ({ isLinked, onLink }) => (
        <div className="p-6 bg-slate-50 min-h-screen text-center"><div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mb-8"><div className="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><Users size={40} className="text-slate-500" /></div><h2 className="text-3xl font-bold text-slate-900 mb-2">{isLinked ? "Sarah (Daughter)" : "Connect to Family"}</h2><p className="text-xl text-slate-600">{isLinked ? "Account is linked. You can share tickets instantly." : "Link accounts to send tickets easily."}</p></div>{!isLinked ? (<button onClick={onLink} className="w-full bg-blue-700 text-white text-2xl font-bold py-5 rounded-2xl shadow-lg">Link Account</button>) : (<div className="bg-green-50 p-6 rounded-2xl border border-green-200"><p className="text-2xl font-bold text-green-800 flex items-center justify-center gap-2"><CheckCircle /> Active</p></div>)}</div>
    );

    const MyTicketsScreen = ({ tickets, isLinked, onSend, onCancelSend }) => (
        <div className="p-6 bg-slate-50 min-h-screen">{tickets.length === 0 ? <p className="text-xl text-slate-400 text-center mt-20">No tickets yet.</p> : tickets.map((ticket, idx) => (<div key={idx} className="bg-white border border-slate-200 rounded-2xl p-6 mb-4 shadow-sm"><div className="flex justify-between items-start mb-4"><div><h3 className="text-2xl font-bold text-slate-900">{ticket.team}</h3><p className="text-xl text-slate-600">{ticket.date}</p></div><span className="bg-slate-100 px-3 py-1 rounded-lg font-bold">x{ticket.count}</span></div><div className="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4"><p className={`text-xl font-bold ${ticket.status.includes('Paid') ? 'text-green-600' : ticket.status.includes('Request') ? 'text-pink-600' : 'text-orange-600'}`}>{ticket.isGift ? 'Sent to Guardian' : ticket.status}</p></div>{isLinked && (!ticket.isGift ? (<button onClick={() => onSend(ticket.purchaseId)} className="w-full py-4 bg-white border-2 border-slate-200 text-slate-700 font-bold rounded-xl flex items-center justify-center gap-2 text-xl active:bg-slate-50"><Send size={24} /> Send to Family</button>) : (<button onClick={() => onCancelSend(ticket.purchaseId)} className="w-full py-4 bg-pink-50 border-2 border-pink-100 text-pink-700 font-bold rounded-xl flex items-center justify-center gap-2 text-xl active:bg-pink-100"><LogOut size={24} /> Cancel Sending</button>))}</div>))}</div>
    );

    // --- MAIN APP ---
    function App() {
        const [currentScreen, setCurrentScreen] = useState('home');
        const [userProfile, setUserProfile] = useState({ name: 'Kim', points: 1200 });
        const [myTickets, setMyTickets] = useState([]);
        const [voiceActive, setVoiceActive] = useState(true);
        const [isLinked, setIsLinked] = useState(false);
        const [groups, setGroups] = useState(INITIAL_GROUPS);
        const [conversationId, setConversationId] = useState('new');

        // Manual Booking State
        const [selectedEvent, setSelectedEvent] = useState(null);
        const [ticketCount, setTicketCount] = useState(1);
        const [paymentMethod, setPaymentMethod] = useState(null);
        const [showConfirmModal, setShowConfirmModal] = useState(false);

        // Chat State
        const [chatMessages, setChatMessages] = useState([]);
        const [chatStep, setChatStep] = useState('idle');
        const [chatInput, setChatInput] = useState('');
        const [isAiLoading, setIsAiLoading] = useState(false);

        const speak = (text) => {
            if (!voiceActive) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        };

        const goBack = () => {
            if (currentScreen === 'checkout') setCurrentScreen('eventDetails');
            else if (currentScreen === 'eventDetails') setCurrentScreen('events');
            else setCurrentScreen('home');
        };

        const handleManualPurchase = () => { setShowConfirmModal(true); speak("Please confirm purchase."); };
        const confirmManualPurchase = () => {
            const status = paymentMethod === 'offline' ? 'Reserved (Pay at Counter)' : paymentMethod === 'guardian_request' ? 'Request Sent to Guardian' : 'Paid';
            const newTicket = { ...selectedEvent, count: ticketCount, purchaseId: Math.floor(Math.random() * 10000), status: status, isGift: false };
            setMyTickets([...myTickets, newTicket]);
            setShowConfirmModal(false);
            setCurrentScreen('success');
            speak("Purchase complete.");
        };

        const handleGuardianLink = () => { setIsLinked(true); speak("Connected to Sarah."); };
        const handleSendTicket = (id) => { setMyTickets(myTickets.map(t => t.purchaseId === id ? { ...t, isGift: true } : t)); speak("Ticket sent."); };
        const handleCancelSend = (id) => { setMyTickets(myTickets.map(t => t.purchaseId === id ? { ...t, isGift: false } : t)); speak("Sending cancelled."); };
        const handleCreateGroup = () => { const newGroup = { id: Date.now(), name: 'New Bowling Team', eventId: 1, members: 1, nextOuting: 'Pending' }; setGroups([...groups, newGroup]); speak("New group created."); };

        // --- Chat Logic (Connected to Backend) ---
        const addChatMessage = (sender, text, uiType = 'text', data = null) => {
            setChatMessages(prev => [...prev, { sender, text, uiType, data }]);
            if (sender === 'ai') speak(text);
        };

        const handleChatSubmit = async () => {
            if (!chatInput.trim()) return;
            const text = chatInput;
            setChatInput('');
            addChatMessage('user', text);
            setIsAiLoading(true);

            try {
                const response = await fetch(`/message/${conversationId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                if (data.conversationId) setConversationId(data.conversationId);
                addChatMessage('ai', data.response);
            } catch (error) {
                addChatMessage('ai', "I'm having trouble connecting to the server.");
            } finally {
                setIsAiLoading(false);
            }
        };

        const handleChatEventSelect = (event) => { addChatMessage('ai', `Selected ${event.team}. How to pay?`); setSelectedEvent(event); setChatStep('payment'); };
        
        const handleChatOption = (option) => {
            if (option.value === 'cancel') { setChatStep('idle'); addChatMessage('ai', "Okay, how else can I help?"); return; }
            if (option.value === 'confirm_booking') { handleChatEventSelect(option.data); return; }

            addChatMessage('user', option.label);
            setTimeout(() => {
                switch (chatStep) {
                    case 'idle':
                        if (option.value === 'book') { addChatMessage('ai', "What kind of event?"); setChatStep('picking_sport'); }
                        else if (option.value === 'mytickets') { addChatMessage('ai', "Opening tickets..."); setCurrentScreen('myTickets'); }
                        break;
                    case 'picking_sport':
                        const matches = EVENTS_DATA.filter(e => e.sport === option.value || e.type === option.value);
                        if (matches.length > 0) {
                            addChatMessage('ai', `I found these ${option.label} events:`, 'text');
                            setChatMessages(prev => [...prev, { sender: 'ai', uiType: 'event_cards', data: matches }]);
                        }
                        break;
                    case 'payment':
                        const isOffline = option.value === 'offline';
                        const newTicket = { ...selectedEvent, count: 1, purchaseId: Math.floor(Math.random()*10000), status: isOffline ? 'Reserved' : 'Paid', isGift: false };
                        setMyTickets(prev => [...prev, newTicket]);
                        addChatMessage('ai', "Ticket booked!");
                        setChatStep('success');
                        break;
                    case 'success':
                        if (option.value === 'home') setCurrentScreen('home');
                        if (option.value === 'mytickets') setCurrentScreen('myTickets');
                        break;
                }
            }, 500);
        };

        useEffect(() => {
            if (currentScreen === 'aiHelp' && chatMessages.length === 0) {
                addChatMessage('ai', `Hello! I am your Silver Sports Assistant. How can I help you today?`);
            }
        }, [currentScreen]);

        return (
            <div className="font-sans max-w-lg mx-auto bg-slate-50 min-h-screen shadow-2xl overflow-hidden relative selection:bg-blue-100">
                <Header title={currentScreen === 'home' ? 'Silver Sports' : currentScreen === 'aiHelp' ? 'Assistant' : 'Back'} userProfile={userProfile} goBack={goBack} showBack={currentScreen !== 'home'} voiceActive={voiceActive} toggleVoice={() => setVoiceActive(!voiceActive)} />
                <main className="pb-safe">
                    {currentScreen === 'home' && <HomeScreen userProfile={userProfile} navigate={setCurrentScreen} />}
                    {(currentScreen === 'events' || currentScreen === 'eventDetails' || currentScreen === 'checkout') && <ManualBookingFlow screen={currentScreen} events={EVENTS_DATA} selectedEvent={selectedEvent} ticketCount={ticketCount} paymentMethod={paymentMethod} onSelectEvent={(e) => { setSelectedEvent(e); setCurrentScreen('eventDetails'); speak(e.team); }} onTicketChange={(delta) => setTicketCount(Math.max(1, ticketCount + delta))} onPaymentMethod={setPaymentMethod} onPurchase={handleManualPurchase} navigate={setCurrentScreen} />}
                    {currentScreen === 'aiHelp' && <AiAssistantScreen chatMessages={chatMessages} chatInput={chatInput} setChatInput={setChatInput} handleChatSubmit={handleChatSubmit} handleChatOption={handleChatOption} isAiLoading={isAiLoading} chatStep={chatStep} />}
                    {currentScreen === 'community' && <CommunityScreen groups={groups} onCreateGroup={handleCreateGroup} />}
                    {currentScreen === 'guardian' && <FamilyLinkScreen isLinked={isLinked} onLink={handleGuardianLink} />}
                    {currentScreen === 'myTickets' && <MyTicketsScreen tickets={myTickets} isLinked={isLinked} onSend={handleSendTicket} onCancelSend={handleCancelSend} />}
                    {currentScreen === 'success' && (<div className="p-6 flex flex-col items-center justify-center min-h-screen bg-green-50 text-center"><CheckCircle size={80} className="text-green-600 mb-6" /><h2 className="text-3xl font-extrabold text-slate-900 mb-4">Success!</h2><button onClick={() => setCurrentScreen('home')} className="w-full bg-slate-800 text-white text-2xl font-bold py-5 rounded-2xl">Go Home</button></div>)}
                </main>
                {showConfirmModal && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white w-full max-w-md rounded-3xl p-8 text-center shadow-2xl"><h2 className="text-3xl font-bold text-slate-900 mb-4">Confirm Purchase?</h2><p className="text-xl text-slate-600 mb-8">{ticketCount} ticket(s) for {selectedEvent?.team}</p><div className="space-y-4"><button onClick={confirmManualPurchase} className="w-full bg-blue-700 text-white text-2xl font-bold py-5 rounded-2xl shadow-md">YES, Buy Now</button><button onClick={() => setShowConfirmModal(false)} className="w-full bg-white text-slate-700 border-2 border-slate-300 text-2xl font-bold py-5 rounded-2xl">No, Cancel</button></div></div></div>)}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>

</body>
</html>